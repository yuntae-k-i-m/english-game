import React, { useState, useEffect, useRef } from 'react';
import { Settings, Trophy, Lightbulb, Volume2, ChevronRight, Play, RotateCcw, Home, Loader2, Keyboard, LogOut, Sparkles } from 'lucide-react';

const apiKey = ""; // API key is provided by the environment

export default function App() {
  // Screen states: 'menu', 'loading', 'quiz', 'result'
  const [screen, setScreen] = useState('menu');
  const [quizData, setQuizData] = useState([]);
  const [usedWords, setUsedWords] = useState([]); // Stores already learned words
  const [currentIdx, setCurrentIdx] = useState(0);
  const [inputValue, setInputValue] = useState("");
  const [hintLevel, setHintLevel] = useState(0);
  const [isCorrect, setIsCorrect] = useState(false);
  const [isWrong, setIsWrong] = useState(false);
  const [showResult, setShowResult] = useState(false);
  const [score, setScore] = useState(0);
  const inputRef = useRef(null);

  // Topics list to ensure variety every session
  const topics = [
    "Business & Professional", "Daily Life & Routine", "Science & Technology", 
    "Travel & Culture", "Emotional & Psychological", "Academic & Formal", 
    "Environment & Nature", "Social Issues", "Art & Literature", "Health & Wellness"
  ];

  // Generate 10 new quizzes using Gemini API
  const generateQuizzes = async (isNewSession = false) => {
    setScreen('loading');
    
    // Pick a random topic to ensure fresh context every time
    const randomTopic = topics[Math.floor(Math.random() * topics.length)];
    
    // Create exclusion list for duplicate prevention
    const excludedWords = isNewSession ? [] : usedWords;
    const exclusionPrompt = excludedWords.length > 0 
      ? `CRITICAL: DO NOT use any of these words: [${excludedWords.join(', ')}]. You MUST provide 10 completely different words.` 
      : "";

    const systemPrompt = `You are an expert English teacher. Generate 10 unique English word quiz items for Korean learners.
    Current Session Theme: ${randomTopic}.
    
    Format: JSON array of objects.
    Each object must have:
    - ko: Korean sentence with the target word highlighted in <span class='text-emerald-500 font-bold'>word</span>.
    - en_pre: English sentence part before the word.
    - en_post: English sentence part after the word.
    - answer: The target English word (lowercase).
    - hintText: A helpful hint in Korean about the word's nuance or meaning.
    - level: A random level number between 20-30.
    
    ${exclusionPrompt}
    Make the words intermediate to advanced level. Focus on variety and avoid common cliché words. 
    Ensure the sentences are natural and contextually rich based on the theme: ${randomTopic}.`;

    const userQuery = `Generate 10 fresh and highly diverse English quiz items related to ${randomTopic}.`;

    try {
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: userQuery }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: { 
            responseMimeType: "application/json",
            temperature: 0.9 // Increased randomness for better variety
          }
        })
      });

      const result = await response.json();
      const fetchedData = JSON.parse(result.candidates[0].content.parts[0].text);
      
      // Update used words list to keep track across "New Quiz" buttons in the same session
      const newAnswers = fetchedData.map(q => q.answer.toLowerCase());
      setUsedWords(prev => [...new Set([...prev, ...newAnswers])]);
      
      // Reset quiz states for the new set
      setQuizData(fetchedData);
      setCurrentIdx(0);
      setInputValue("");
      setHintLevel(0);
      setIsCorrect(false);
      setIsWrong(false);
      setShowResult(false);
      setScore(0);
      setScreen('quiz');
    } catch (error) {
      console.error("Error fetching quizzes:", error);
      // Fallback data
      setQuizData([
        {
          ko: "그의 이야기의 <span class='text-emerald-500 font-bold'>신빙성</span>을 어떻게 확인할 수 있을까?",
          en_pre: "How can we verify the",
          en_post: "of his story?",
          answer: "authenticity",
          hintText: "진짜임을 뜻하는 단어입니다.",
          level: 26
        }
      ]);
      setScreen('quiz');
    }
  };

  const currentQuiz = quizData[currentIdx];

  useEffect(() => {
    if (screen === 'quiz' && inputRef.current) {
      inputRef.current.focus();
    }
  }, [screen, currentIdx]);

  const speak = (text) => {
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    window.speechSynthesis.speak(utterance);
  };

  const handleCheck = () => {
    const trimmedInput = inputValue.toLowerCase().trim();
    if (!trimmedInput) return;
    
    const isAnswerCorrect = trimmedInput === currentQuiz.answer.toLowerCase();

    if (isAnswerCorrect) {
      setIsCorrect(true);
      setIsWrong(false);
      setShowResult(true);
      setScore(prev => prev + 1);
      
      // Auto-speak full sentence on correct answer
      const fullSentence = `${currentQuiz.en_pre} ${currentQuiz.answer} ${currentQuiz.en_post}`;
      speak(fullSentence);
    } else {
      setIsWrong(true);
      setTimeout(() => setIsWrong(false), 800);
    }
  };

  const handleHint = () => {
    // Clear input when hint is requested
    setInputValue("");
    if (hintLevel < 2) {
      setHintLevel(hintLevel + 1);
    }
    if (inputRef.current) inputRef.current.focus();
  };

  const nextQuestion = () => {
    if (currentIdx < quizData.length - 1) {
      setCurrentIdx(currentIdx + 1);
      setInputValue("");
      setHintLevel(0);
      setIsCorrect(false);
      setIsWrong(false);
      setShowResult(false);
    } else {
      setScreen('result');
    }
  };

  const handleKeyDown = (e) => {
    // Hint Shortcut: '1'
    if (e.key === '1' && !showResult && !isCorrect) {
      e.preventDefault();
      handleHint();
      return;
    }

    // Check/Next Shortcut: Enter or Space
    if (e.key === 'Enter' || e.key === ' ') {
      e.preventDefault();
      if (showResult) {
        nextQuestion();
      } else {
        handleCheck();
      }
    }
  };

  const getHintPlaceholder = () => {
    if (!currentQuiz) return "";
    const word = currentQuiz.answer;
    if (hintLevel === 0) {
      return word[0] + "_".repeat(word.length - 1);
    } else if (hintLevel === 1) {
      return word.substring(0, 3) + "_".repeat(Math.max(0, word.length - 3));
    } else {
      return word;
    }
  };

  // --- UI Screens ---

  if (screen === 'menu') {
    return (
      <div className="min-h-screen bg-[#d0e1f9] flex flex-col items-center justify-center p-6 text-center">
        <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md flex flex-col items-center border-4 border-white">
          <div className="w-20 h-20 bg-purple-100 rounded-3xl flex items-center justify-center mb-6 shadow-inner border border-purple-50">
            <Trophy size={40} className="text-purple-600 fill-purple-600" />
          </div>
          <h1 className="text-3xl font-bold text-gray-800 mb-2 tracking-tight">말해봐 잉글리시</h1>
          <p className="text-gray-500 mb-8 font-medium">AI가 생성하는 다채로운 문장으로 학습하세요</p>
          
          <button 
            onClick={() => {
              setUsedWords([]); 
              generateQuizzes(true);
            }}
            className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-5 rounded-2xl flex items-center justify-center gap-3 shadow-lg transition-all active:scale-95 mb-4"
          >
            <Play fill="white" size={20} />
            학습 시작하기
          </button>
          
          {usedWords.length > 0 && (
             <p className="text-xs text-purple-400 font-bold italic">
               오늘의 누적 학습량: {usedWords.length} 단어
             </p>
          )}
        </div>
      </div>
    );
  }

  if (screen === 'loading') {
    return (
      <div className="min-h-screen bg-[#d0e1f9] flex flex-col items-center justify-center p-6 text-center">
        <div className="bg-white/90 backdrop-blur-sm p-12 rounded-[3rem] shadow-lg flex flex-col items-center">
          <div className="relative w-16 h-16 mb-6">
             <Loader2 size={64} className="text-purple-600 animate-spin" />
             <div className="absolute inset-0 flex items-center justify-center">
                <Sparkles size={24} className="text-yellow-400 animate-pulse" />
             </div>
          </div>
          <p className="text-purple-700 font-bold text-lg animate-pulse tracking-tight">
            새로운 주제로 문제를 구성 중...
          </p>
          <span className="mt-2 text-xs text-purple-400 font-medium tracking-widest uppercase">Creating unique challenges</span>
        </div>
      </div>
    );
  }

  if (screen === 'result') {
    return (
      <div className="min-h-screen bg-[#d0e1f9] flex flex-col items-center justify-center p-6 text-center">
        <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md flex flex-col items-center">
          <Sparkles size={48} className="text-yellow-400 mb-4 animate-bounce" />
          <h2 className="text-2xl font-bold text-gray-800 mb-2">학습 성공!</h2>
          <div className="text-6xl font-black text-purple-600 my-6 tracking-tighter">
            {score * 10}<span className="text-2xl text-gray-400 ml-1 font-bold">점</span>
          </div>
          <p className="text-gray-500 mb-8 leading-relaxed font-medium">
            10문제 중 <span className="text-purple-600 font-bold">{score}문제를</span> 맞혔습니다.<br/>
            누적 학습량: {usedWords.length} 단어
          </p>
          
          <div className="w-full flex flex-col gap-3">
            <button 
              onClick={() => generateQuizzes(false)}
              className="w-full bg-purple-600 text-white font-bold py-4 rounded-2xl flex items-center justify-center gap-2 shadow-md active:scale-95 transition-all hover:bg-purple-700"
            >
              <Sparkles size={20} /> 새로운 문제 학습하기
            </button>
            <button 
              onClick={() => {
                setUsedWords([]);
                setScreen('menu');
              }}
              className="w-full bg-gray-100 text-gray-600 font-bold py-4 rounded-2xl flex items-center justify-center gap-2 active:scale-95 hover:bg-gray-200 transition-all"
            >
              <LogOut size={20} /> 학습 마무리하기
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Quiz Screen Render
  const progress = ((currentIdx + 1) / quizData.length) * 100;

  return (
    <div className="min-h-screen bg-[#d0e1f9] flex flex-col items-center font-sans p-4 select-none">
      {/* Top Bar */}
      <div className="w-full max-w-md flex items-center justify-between mb-6 px-2">
        <button onClick={() => setScreen('menu')} className="p-2 hover:bg-white/20 rounded-full transition-colors">
          <ChevronRight className="rotate-180 text-gray-500" />
        </button>
        <div className="flex-1 mx-4">
          <div className="flex items-center gap-2 mb-1">
            <Trophy size={18} className="text-orange-400 fill-orange-400" />
            <span className="text-sm font-bold text-gray-600">{currentIdx + 1}/{quizData.length}</span>
          </div>
          <div className="w-full h-3 bg-white/50 rounded-full overflow-hidden shadow-inner">
            <div 
              className="h-full bg-orange-400 transition-all duration-500 rounded-full" 
              style={{ width: `${progress}%` }}
            ></div>
          </div>
        </div>
        <Settings className="text-gray-500 cursor-pointer" />
      </div>

      {/* Main Card */}
      <div className={`w-full max-w-md bg-white rounded-[2.5rem] shadow-xl p-8 flex flex-col min-h-[480px] relative transition-all duration-300 border-4 border-white`}>
        <div className="flex items-center gap-1 mb-4">
          <span className="bg-blue-100 text-blue-500 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest">
            레벨 {currentQuiz?.level}
          </span>
          <div className="ml-auto bg-red-400 text-white px-3 py-1 rounded-full text-xs font-bold shadow-sm">New</div>
        </div>

        <h2 
          className="text-xl font-bold text-gray-800 leading-snug mb-6"
          dangerouslySetInnerHTML={{ __html: currentQuiz?.ko }}
        />

        {/* Hint Bubble */}
        {hintLevel >= 1 && (
          <div className="bg-rose-100 text-rose-600 p-4 rounded-2xl mb-6 relative animate-in fade-in slide-in-from-top-2 duration-300 shadow-sm border border-rose-200/50">
            <div className="flex gap-2">
              <Lightbulb size={18} className="shrink-0" />
              <p className="text-sm leading-relaxed font-medium">{currentQuiz?.hintText}</p>
            </div>
            <div className="absolute -bottom-2 left-8 w-4 h-4 bg-rose-100 rotate-45 border-r border-b border-rose-200/50"></div>
          </div>
        )}

        {/* Question Area */}
        <div className="text-2xl text-gray-800 leading-relaxed tracking-tight mb-auto font-medium">
          {currentQuiz?.en_pre}{" "}
          <div className="inline-block relative">
            <input
              ref={inputRef}
              type="text"
              value={inputValue}
              onChange={(e) => {
                setInputValue(e.target.value);
                setIsWrong(false);
              }}
              onKeyDown={handleKeyDown}
              placeholder={getHintPlaceholder()}
              readOnly={isCorrect}
              className={`
                min-w-[100px] border-b-4 outline-none text-center px-2 transition-all duration-300
                ${isCorrect ? 'border-emerald-400 text-emerald-500 cursor-default' : isWrong ? 'border-red-400 text-red-500 animate-shake' : 'border-blue-200 focus:border-blue-500'}
                bg-transparent placeholder:text-blue-100 placeholder:opacity-70 font-mono tracking-widest
              `}
              style={{ width: `${Math.max(currentQuiz?.answer.length * 1.3, 5)}rem` }}
            />
          </div>
          {" "}{currentQuiz?.en_post}
        </div>

        {/* Guide Tooltip */}
        <div className="mt-4 text-center flex flex-col gap-1">
           <span className="inline-flex items-center justify-center gap-1.5 text-[10px] font-bold text-gray-300 bg-gray-50 px-2 py-1 rounded-md">
             <Keyboard size={12} /> SPACE 로 확인 / 다음
           </span>
           {!showResult && (
             <span className="text-[9px] font-bold text-purple-200 uppercase tracking-widest">숫자 1: 힌트</span>
           )}
        </div>

        {/* Answer Reveal */}
        {isCorrect && (
          <div className="mt-8 flex justify-center animate-in zoom-in duration-300">
            <div className="bg-indigo-600 text-white px-6 py-2 rounded-xl text-lg font-bold shadow-md">
              {currentQuiz?.answer}
            </div>
          </div>
        )}
      </div>

      {/* Footer Controls */}
      <div className="w-full max-w-md mt-auto pt-6 pb-8 grid grid-cols-3 gap-4">
        {!showResult ? (
          <>
            <button 
              onClick={handleHint}
              className="flex flex-col items-center justify-center gap-1 group"
            >
              <div className="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-md group-active:scale-95 transition-transform border border-gray-100">
                <Lightbulb size={24} className={hintLevel === 2 ? "text-gray-300" : "text-purple-500"} />
              </div>
              <span className="text-[11px] font-bold text-purple-600 mt-1 uppercase tracking-tighter font-black">힌트 (1)</span>
            </button>
            
            <button 
              onClick={handleCheck}
              className="flex flex-col items-center justify-center gap-1 group"
            >
              <div className="w-14 h-14 bg-purple-600 rounded-2xl flex items-center justify-center shadow-md group-active:scale-95 transition-transform shadow-purple-200">
                <ChevronRight size={28} className="text-white" />
              </div>
              <span className="text-[11px] font-bold text-purple-600 mt-1 uppercase tracking-tighter font-black">확인</span>
            </button>

            <button 
              onClick={() => speak(`${currentQuiz?.en_pre} ${currentQuiz?.answer} ${currentQuiz?.en_post}`)}
              className="flex flex-col items-center justify-center gap-1 group"
            >
              <div className="w-14 h-14 bg-white rounded-2xl flex items-center justify-center shadow-md group-active:scale-95 transition-transform border border-gray-100">
                <Volume2 size={24} className="text-blue-400" />
              </div>
              <span className="text-[11px] font-bold text-blue-500 mt-1 uppercase tracking-tighter font-black">듣기</span>
            </button>
          </>
        ) : (
          <div className="col-span-3 flex gap-3 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <button 
              onClick={() => speak(`${currentQuiz?.en_pre} ${currentQuiz?.answer} ${currentQuiz?.en_post}`)}
              className="flex-1 bg-white h-20 rounded-3xl flex flex-col items-center justify-center shadow-lg active:scale-95 transition-all border border-gray-100 hover:bg-gray-50"
            >
              <Volume2 size={28} className="text-blue-500 mb-1" />
              <span className="text-[10px] font-black text-blue-500 uppercase tracking-widest">다시 듣기</span>
            </button>
            <button 
              onClick={nextQuestion}
              className="flex-[2] bg-indigo-600 h-20 rounded-3xl flex flex-col items-center justify-center shadow-lg active:scale-95 transition-all hover:bg-indigo-700 shadow-indigo-200"
            >
              <ChevronRight size={32} className="text-white mb-1" />
              <span className="text-xs font-black text-white uppercase tracking-widest">다음 문제 (SPACE)</span>
            </button>
          </div>
        )}
      </div>

      <style>{`
        @keyframes shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-6px); }
          50% { transform: translateX(6px); }
          75% { transform: translateX(-6px); }
        }
        .animate-shake {
          animation: shake 0.4s ease-in-out;
        }
      `}</style>
    </div>
  );
}