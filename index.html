<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>말해봐 잉글리시 - AI 영어 단어 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-6px); }
            50% { transform: translateX(6px); }
            75% { transform: translateX(-6px); }
        }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        body { background-color: #d0e1f9; font-family: sans-serif; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // API 키 설정
        const apiKey = "AIzaSyAU95xLMS6iWStHCL0HOdQbjKx0xaBoh1M"; 

        function App() {
            const [screen, setScreen] = useState('menu');
            const [quizData, setQuizData] = useState([]);
            const [usedWords, setUsedWords] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [inputValue, setInputValue] = useState("");
            const [hintLevel, setHintLevel] = useState(0);
            const [isCorrect, setIsCorrect] = useState(false);
            const [isWrong, setIsWrong] = useState(false);
            const [showResult, setShowResult] = useState(false);
            const [score, setScore] = useState(0);

            const topics = [
                "Business & Professional", "Daily Life & Routine", "Science & Technology", 
                "Travel & Culture", "Emotional & Psychological", "Academic & Formal", 
                "Environment & Nature", "Social Issues", "Art & Literature", "Health & Wellness"
            ];

            // 아이콘 업데이트 로직
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [screen, hintLevel, isCorrect, showResult]);

            const generateQuizzes = async (isNewSession = false) => {
                setScreen('loading');
                const randomTopic = topics[Math.floor(Math.random() * topics.length)];
                const excludedWords = isNewSession ? [] : usedWords;
                
                const systemPrompt = `You are an expert English teacher. Generate 10 unique English word quiz items for Korean learners.
                Current Session Theme: ${randomTopic}. 
                Format: JSON array of objects. Each object must have:
                ko: Korean sentence with target word in <span class='text-emerald-500 font-bold'>word</span>.
                en_pre: English before word, en_post: English after word, answer: word(lowercase), 
                hintText: Korean hint, level: 20-30.`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey)`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: `Generate 10 fresh quiz items for ${randomTopic}. Avoid: ${excludedWords.join(',')}` }] }],
                            systemInstruction: { parts: [{ text: systemPrompt }] },
                            generationConfig: { responseMimeType: "application/json", temperature: 0.9 }
                        })
                    });

                    const result = await response.json();
                    const fetchedData = JSON.parse(result.candidates[0].content.parts[0].text);
                    
                    setUsedWords(prev => [...new Set([...prev, ...fetchedData.map(q => q.answer.toLowerCase())])]);
                    setQuizData(fetchedData);
                    setCurrentIdx(0); setInputValue(""); setHintLevel(0);
                    setIsCorrect(false); setIsWrong(false); setShowResult(false);
                    setScore(0); setScreen('quiz');
                } catch (error) {
                    console.error("Error:", error);
                    alert("문제를 생성하는 중 오류가 발생했습니다. API 키 활성화 상태를 확인해주세요.");
                    setScreen('menu');
                }
            };

            const handleCheck = () => {
                const currentQuiz = quizData[currentIdx];
                if (inputValue.toLowerCase().trim() === currentQuiz.answer.toLowerCase()) {
                    setIsCorrect(true); setShowResult(true); setScore(s => s + 1);
                    const utterance = new SpeechSynthesisUtterance(`${currentQuiz.en_pre} ${currentQuiz.answer} ${currentQuiz.en_post}`);
                    window.speechSynthesis.speak(utterance);
                } else {
                    setIsWrong(true); setTimeout(() => setIsWrong(false), 800);
                }
            };

            if (screen === 'menu') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md border-4 border-white">
                        <div className="w-20 h-20 bg-purple-100 rounded-3xl flex items-center justify-center mb-6 mx-auto">
                            <i data-lucide="trophy" className="text-purple-600 w-10 h-10"></i>
                        </div>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">말해봐 잉글리시</h1>
                        <p className="text-gray-500 mb-8 font-medium">AI가 만드는 새로운 문장으로 학습하세요</p>
                        <button onClick={() => generateQuizzes(true)} className="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-5 rounded-2xl shadow-lg transition-all active:scale-95">
                            학습 시작하기
                        </button>
                    </div>
                </div>
            );

            if (screen === 'loading') return (
                <div className="min-h-screen flex flex-col items-center justify-center">
                    <div className="bg-white/90 p-12 rounded-[3rem] shadow-lg flex flex-col items-center">
                        <i data-lucide="loader-2" className="text-purple-600 w-16 h-16 animate-spin"></i>
                        <p className="text-purple-700 font-bold text-lg mt-4 animate-pulse">새로운 문제를 만드는 중...</p>
                    </div>
                </div>
            );

            if (screen === 'result') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md border-4 border-white">
                        <i data-lucide="sparkles" className="text-yellow-400 w-12 h-12 mx-auto mb-4"></i>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">학습 성공!</h2>
                        <div className="text-5xl font-black text-purple-600 my-6">{score * 10}점</div>
                        <button onClick={() => generateQuizzes(false)} className="w-full bg-purple-600 text-white font-bold py-4 rounded-2xl mb-3 shadow-md">새로운 문제 도전</button>
                        <button onClick={() => setScreen('menu')} className="w-full bg-gray-100 text-gray-600 font-bold py-4 rounded-2xl">처음으로</button>
                    </div>
                </div>
            );

            const currentQuiz = quizData[currentIdx];
            const progress = ((currentIdx + 1) / quizData.length) * 100;

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <div className="w-full max-w-md flex items-center justify-between mb-6 px-2">
                        <div className="flex-1 mx-4 mt-8">
                            <div className="flex justify-between mb-2">
                                <span className="text-xs font-bold text-gray-500">{currentIdx + 1} / 10</span>
                            </div>
                            <div className="w-full h-3 bg-white/50 rounded-full overflow-hidden">
                                <div className="h-full bg-orange-400 transition-all duration-500" style={{ width: `${progress}%` }}></div>
                            </div>
                        </div>
                    </div>

                    <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-xl p-8 flex flex-col min-h-[480px] border-4 border-white relative">
                        <span className="bg-blue-100 text-blue-500 px-3 py-1 rounded-full text-[10px] font-black w-fit mb-4 uppercase">LEVEL {currentQuiz?.level}</span>
                        <h2 className="text-xl font-bold text-gray-800 leading-snug mb-6" dangerouslySetInnerHTML={{ __html: currentQuiz?.ko }} />
                        
                        {hintLevel >= 1 && (
                            <div className="bg-rose-100 text-rose-600 p-4 rounded-2xl mb-6 text-sm font-medium border border-rose-200">{currentQuiz?.hintText}</div>
                        )}

                        <div className="text-2xl text-gray-800 leading-relaxed mb-auto">
                            {currentQuiz?.en_pre} 
                            <input 
                                className={`border-b-4 outline-none text-center mx-2 transition-all ${isCorrect ? 'border-emerald-400 text-emerald-500' : isWrong ? 'border-red-400 animate-shake' : 'border-blue-200 focus:border-blue-500'}`}
                                style={{ width: '8rem' }}
                                value={inputValue}
                                onChange={(e) => {setInputValue(e.target.value); setIsWrong(false);}}
                                onKeyDown={(e) => e.key === 'Enter' && (showResult ? (currentIdx < 9 ? (setCurrentIdx(c => c+1), setInputValue(""), setShowResult(false), setIsCorrect(false), setHintLevel(0)) : setScreen('result')) : handleCheck())}
                                autoFocus
                            />
                            {currentQuiz?.en_post}
                        </div>

                        <div className="flex gap-4 mt-8">
                            {!showResult ? (
                                <>
                                    <button onClick={() => setHintLevel(prev => Math.min(prev + 1, 2))} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold text-gray-600 active:scale-95 transition-transform">힌트</button>
                                    <button onClick={handleCheck} className="flex-1 bg-purple-600 py-4 rounded-2xl font-bold text-white shadow-lg active:scale-95 transition-transform">확인</button>
                                </>
                            ) : (
                                <button onClick={() => {
                                    if(currentIdx < 9) {
                                        setCurrentIdx(c => c + 1); setInputValue(""); setShowResult(false); setIsCorrect(false); setHintLevel(0);
                                    } else { setScreen('result'); }
                                }} className="w-full bg-indigo-600 py-4 rounded-2xl font-bold text-white shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                                    다음 문제 <i data-lucide="chevron-right"></i>
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

