<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>말해봐 잉글리시 - AI 영어 퀴즈</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 50% { transform: translateX(6px); } 75% { transform: translateX(-6px); } }
        .animate-shake { animation: shake 0.4s ease-in-out; }
        body { background-color: #d0e1f9; font-family: sans-serif; margin: 0; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // 제공해주신 API 키 적용
        const apiKey = "AIzaSyAU95xLMS6iWStHCL0HOdQbjKx0xaBoh1M"; 

        function App() {
            const [screen, setScreen] = useState('menu');
            const [quizData, setQuizData] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [inputValue, setInputValue] = useState("");
            const [hintLevel, setHintLevel] = useState(0);
            const [isCorrect, setIsCorrect] = useState(false);
            const [isWrong, setIsWrong] = useState(false);
            const [showResult, setShowResult] = useState(false);
            const [score, setScore] = useState(0);

            const topics = ["Business", "Daily Life", "Technology", "Travel", "Health"];

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [screen, hintLevel, isCorrect, showResult]);

            const generateQuizzes = async () => {
                setScreen('loading');
                const randomTopic = topics[Math.floor(Math.random() * topics.length)];
                
                const prompt = `Generate 10 English word quiz items for Korean learners about ${randomTopic}. 
                Format: JSON array of objects. Each object: { "ko": "Korean sentence with <span class='text-emerald-500 font-bold'>word</span>", "en_pre": "English before", "en_post": "English after", "answer": "word", "hintText": "Korean hint", "level": 25 }`;

                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }],
                            generationConfig: { responseMimeType: "application/json" }
                        })
                    });

                    const data = await response.json();
                    const text = data.candidates[0].content.parts[0].text;
                    const parsedData = JSON.parse(text);
                    
                    setQuizData(parsedData);
                    setScreen('quiz');
                } catch (error) {
                    console.error("API Error:", error);
                    // API 실패 시 테스트용 데이터로 진행 (연결 확인용)
                    setQuizData([{
                        ko: "그는 <span class='text-emerald-500 font-bold'>창의적인</span> 아이디어가 많다.",
                        en_pre: "He has many", en_post: "ideas.", answer: "creative",
                        hintText: "C로 시작하는 '독창적인'이라는 뜻입니다.", level: 20
                    }]);
                    setScreen('quiz');
                }
                // 초기화
                setCurrentIdx(0); setInputValue(""); setHintLevel(0); setIsCorrect(false); setShowResult(false); setScore(0);
            };

            const handleCheck = () => {
                if (inputValue.toLowerCase().trim() === quizData[currentIdx].answer.toLowerCase()) {
                    setIsCorrect(true); setShowResult(true); setScore(s => s + 1);
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(`${quizData[currentIdx].en_pre} ${quizData[currentIdx].answer} ${quizData[currentIdx].en_post}`));
                } else {
                    setIsWrong(true); setTimeout(() => setIsWrong(false), 800);
                }
            };

            if (screen === 'menu') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md border-4 border-white">
                        <i data-lucide="trophy" className="text-purple-600 w-16 h-16 mx-auto mb-6"></i>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">말해봐 잉글리시</h1>
                        <p className="text-gray-500 mb-8">AI와 함께하는 실전 영어 퀴즈</p>
                        <button onClick={generateQuizzes} className="w-full bg-purple-600 text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95 transition-all">학습 시작하기</button>
                    </div>
                </div>
            );

            if (screen === 'loading') return (
                <div className="min-h-screen flex flex-col items-center justify-center">
                    <i data-lucide="loader-2" className="text-purple-600 w-16 h-16 animate-spin"></i>
                    <p className="text-purple-700 font-bold mt-4">문제를 생성하고 있습니다...</p>
                </div>
            );

            const currentQuiz = quizData[currentIdx];
            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-xl p-8 mt-10 min-h-[450px] border-4 border-white relative">
                        <div className="mb-4 text-xs font-bold text-blue-500 uppercase">Level {currentQuiz?.level}</div>
                        <h2 className="text-xl font-bold text-gray-800 mb-6" dangerouslySetInnerHTML={{ __html: currentQuiz?.ko }} />
                        {hintLevel > 0 && <div className="bg-rose-50 text-rose-600 p-4 rounded-xl mb-6 text-sm">{currentQuiz?.hintText}</div>}
                        <div className="text-2xl text-gray-800 mb-auto">
                            {currentQuiz?.en_pre} 
                            <input className={`border-b-4 outline-none text-center mx-2 w-32 ${isCorrect ? 'border-emerald-400 text-emerald-500' : isWrong ? 'border-red-400 animate-shake' : 'border-blue-200 focus:border-blue-500'}`}
                                value={inputValue} onChange={(e) => setInputValue(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && (showResult ? (currentIdx < quizData.length - 1 ? (setCurrentIdx(c => c+1), setInputValue(""), setShowResult(false), setIsCorrect(false), setHintLevel(0)) : setScreen('menu')) : handleCheck())}
                            />
                            {currentQuiz?.en_post}
                        </div>
                        <div className="flex gap-4 mt-8">
                            {!showResult ? (
                                <><button onClick={() => setHintLevel(1)} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold">힌트</button>
                                <button onClick={handleCheck} className="flex-1 bg-purple-600 text-white py-4 rounded-2xl font-bold">확인</button></>
                            ) : (
                                <button onClick={() => currentIdx < quizData.length - 1 ? (setCurrentIdx(c => c+1), setInputValue(""), setShowResult(false), setIsCorrect(false), setHintLevel(0)) : setScreen('menu')} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">다음 문제</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
