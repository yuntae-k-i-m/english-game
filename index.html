<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>말해봐 잉글리시 (Final v2.5)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { background-color: #d0e1f9; font-family: sans-serif; margin: 0; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-6px); } 50% { transform: translateX(6px); } 75% { transform: translateX(-6px); } }
        .animate-shake { animation: shake 0.4s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // API Key
        const apiKey = "AIzaSyAU95xLMS6iWStHCL0HOdQbjKx0xaBoh1M"; 

        function App() {
            const [screen, setScreen] = useState('menu');
            const [quizData, setQuizData] = useState([]);
            const [currentIdx, setCurrentIdx] = useState(0);
            const [inputValue, setInputValue] = useState("");
            const [hintLevel, setHintLevel] = useState(0);
            const [isCorrect, setIsCorrect] = useState(false);
            const [isWrong, setIsWrong] = useState(false);
            const [showResult, setShowResult] = useState(false);
            const [score, setScore] = useState(0);
            const [debugLog, setDebugLog] = useState(""); 
            const [activeModel, setActiveModel] = useState(""); // 현재 연결된 모델 표시

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [screen, hintLevel, isCorrect, showResult]);

            // [비상용 데이터] API가 모두 실패했을 때 사용
            const fallbackData = [
                {
                    ko: "그는 <span class='text-emerald-500 font-bold'>창의적인</span> 아이디어가 많다.",
                    en_pre: "He has many", en_post: "ideas.", answer: "creative",
                    hintText: "C로 시작하는 '독창적인'", level: 20
                },
                {
                    ko: "이 문제를 <span class='text-emerald-500 font-bold'>해결</span>해야 한다.",
                    en_pre: "We need to", en_post: "this problem.", answer: "solve",
                    hintText: "S로 시작하는 '풀다'", level: 15
                }
            ];

            const generateQuizzes = async () => {
                setScreen('loading');
                setDebugLog("AI 모델 검색 중...");
                
                const topics = ["Business", "Daily Life", "Travel", "Health"];
                const randomTopic = topics[Math.floor(Math.random() * topics.length)];
                
                const prompt = `Generate 10 English word quiz items for Korean learners about ${randomTopic}.
                OUTPUT FORMAT: JSON Array only. No Markdown.
                [{"ko": "문장 <span class='text-emerald-500 font-bold'>단어</span>", "en_pre": "start", "en_post": "end", "answer": "word", "hintText": "hint", "level": 1}]`;

                // [중요] 2026년 기준 모델 우선순위 리스트 (2.5 -> 2.0 -> 최후의 수단 1.5)
                const models = [
                    'gemini-2.5-flash',       // 1순위: 최신 표준
                    'gemini-2.5-flash-001',   // 2순위: 버전 명시
                    'gemini-2.0-flash',       // 3순위: 이전 안정 버전
                    'gemini-1.5-flash'        // 4순위: 레거시 (혹시 몰라 남겨둠)
                ];
                
                let success = false;

                for (const model of models) {
                    try {
                        setDebugLog(`연결 시도: ${model}...`);
                        
                        // 5초 타임아웃 (무한 로딩 방지)
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);

                        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            // 404면 모델 없음, 400이면 요청 오류 -> 다음 모델로 넘어감
                            throw new Error(`HTTP ${response.status}`);
                        }

                        const data = await response.json();
                        let text = data.candidates[0].content.parts[0].text;
                        text = text.replace(/```json/g, "").replace(/```/g, "").trim();
                        const parsedData = JSON.parse(text);

                        if (parsedData && parsedData.length > 0) {
                            setQuizData(parsedData);
                            setActiveModel(model); // 성공한 모델 저장
                            setScreen('quiz');
                            success = true;
                            break; // 성공했으니 루프 종료
                        }
                    } catch (error) {
                        console.warn(`Model ${model} failed:`, error);
                        // 실패 시 다음 모델 시도
                    }
                }

                if (!success) {
                    setDebugLog("모든 모델 연결 실패. 예시 문제 실행.");
                    alert("AI 연결에 실패하여 비상용 예시 문제로 시작합니다.");
                    setQuizData(fallbackData);
                    setActiveModel("Offline Mode");
                    setScreen('quiz');
                }

                // 상태 초기화
                setCurrentIdx(0); setInputValue(""); setHintLevel(0); setIsCorrect(false); setShowResult(false); setScore(0);
            };

            const handleCheck = () => {
                const dataToUse = (quizData && quizData.length > 0) ? quizData : fallbackData;
                const currentQuiz = dataToUse[currentIdx];
                
                if (!currentQuiz) return;

                if (inputValue.toLowerCase().trim() === currentQuiz.answer.toLowerCase()) {
                    setIsCorrect(true); setShowResult(true); setScore(s => s + 1);
                    window.speechSynthesis.speak(new SpeechSynthesisUtterance(`${currentQuiz.en_pre} ${currentQuiz.answer} ${currentQuiz.en_post}`));
                } else {
                    setIsWrong(true); setTimeout(() => setIsWrong(false), 800);
                }
            };

            // UI 렌더링
            if (screen === 'menu') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white p-10 rounded-[3rem] shadow-2xl w-full max-w-md border-4 border-white">
                        <i data-lucide="trophy" className="text-purple-600 w-16 h-16 mx-auto mb-6"></i>
                        <h1 className="text-3xl font-bold text-gray-800 mb-2">말해봐 잉글리시</h1>
                        <span className="bg-indigo-100 text-indigo-600 px-2 py-1 rounded text-xs font-bold mb-4 inline-block">v2.5 (최신버전)</span>
                        <p className="text-gray-500 mb-8">매번 새로운 AI 영어 퀴즈</p>
                        <button onClick={generateQuizzes} className="w-full bg-purple-600 text-white font-bold py-5 rounded-2xl shadow-lg active:scale-95">학습 시작하기</button>
                    </div>
                </div>
            );

            if (screen === 'loading') return (
                <div className="min-h-screen flex flex-col items-center justify-center">
                    <i data-lucide="loader-2" className="text-purple-600 w-16 h-16 animate-spin"></i>
                    <p className="text-purple-700 font-bold mt-4 mb-2">AI 모델 연결 중...</p>
                    <p className="text-xs text-gray-400 font-mono">{debugLog}</p>
                </div>
            );

            const currentQuiz = (quizData && quizData[currentIdx]) ? quizData[currentIdx] : fallbackData[0];

            return (
                <div className="min-h-screen flex flex-col items-center p-4">
                    <div className="w-full max-w-md bg-white rounded-[2.5rem] shadow-xl p-8 mt-10 min-h-[450px] border-4 border-white relative">
                        <div className="flex justify-between items-center mb-4">
                            <span className="text-xs font-bold text-blue-500 uppercase">Level {currentQuiz.level}</span>
                            <span className="text-[10px] text-gray-300 font-mono">{activeModel}</span>
                        </div>
                        <h2 className="text-xl font-bold text-gray-800 mb-6" dangerouslySetInnerHTML={{ __html: currentQuiz.ko }} />
                        {hintLevel > 0 && <div className="bg-rose-50 text-rose-600 p-4 rounded-xl mb-6 text-sm">{currentQuiz.hintText}</div>}
                        <div className="text-2xl text-gray-800 mb-auto leading-relaxed">
                            {currentQuiz.en_pre} 
                            <input className={`border-b-4 outline-none text-center mx-2 w-32 ${isCorrect ? 'border-emerald-400 text-emerald-500' : isWrong ? 'border-red-400 animate-shake' : 'border-blue-200 focus:border-blue-500'}`}
                                value={inputValue} onChange={(e) => setInputValue(e.target.value)}
                                onKeyDown={(e) => e.key === 'Enter' && (showResult ? (currentIdx < (quizData.length || fallbackData.length) - 1 ? (setCurrentIdx(c => c+1), setInputValue(""), setShowResult(false), setIsCorrect(false), setHintLevel(0)) : setScreen('menu')) : handleCheck())}
                                autoFocus
                            />
                            {currentQuiz.en_post}
                        </div>
                        <div className="flex gap-4 mt-8">
                            {!showResult ? (
                                <><button onClick={() => setHintLevel(1)} className="flex-1 bg-gray-100 py-4 rounded-2xl font-bold">힌트</button>
                                <button onClick={handleCheck} className="flex-1 bg-purple-600 text-white py-4 rounded-2xl font-bold">확인</button></>
                            ) : (
                                <button onClick={() => currentIdx < (quizData.length || fallbackData.length) - 1 ? (setCurrentIdx(c => c+1), setInputValue(""), setShowResult(false), setIsCorrect(false), setHintLevel(0)) : setScreen('menu')} className="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">다음 문제</button>
                            )}
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
